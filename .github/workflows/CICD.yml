name: CICD

# spell-checker:ignore (shell/tools) nextest sccache taiki Swatinem dtolnay

on:
  pull_request:
  push:
    branches:
      - '*'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  # Temporary job to validate tac Windows stdin fix is not flaky
  # Uses a matrix to run 5 parallel jobs, each running tac tests 20 times
  test_tac_windows_flaky:
    name: Test/tac-windows-flaky-${{ matrix.batch }}
    runs-on: windows-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        batch: [1, 2, 3, 4, 5]
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
      CARGO_INCREMENTAL: 0
    steps:
    - uses: actions/checkout@v6
      with:
        persist-credentials: false
    - uses: dtolnay/rust-toolchain@stable
    - uses: taiki-e/install-action@nextest
    - uses: Swatinem/rust-cache@v2
    - name: Run sccache-cache
      uses: mozilla-actions/sccache-action@v0.0.9
    - name: Run tac tests 20 times (batch ${{ matrix.batch }}/5)
      shell: bash
      run: |
        for i in $(seq 1 20); do
          echo "=== Batch ${{ matrix.batch }}, Run $i/20 ==="
          cargo nextest run --hide-progress-bar --features feat_os_windows -E 'test(test_tac)' || exit 1
        done
      env:
        RUST_BACKTRACE: "1"
